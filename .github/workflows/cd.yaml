name: CD

on:
  push:
    tags: ["v*", "v*.*", "v*.*.*"]

permissions:
  contents: read

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_app:
    name: Build & Push Next.js (arm64)
    runs-on: ubuntu-24.04-arm
    environment:
      name: PROD
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta (app)
        id: meta_app
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/personal-website
          tags: |
            type=ref,event=tag

      - name: Build and push (Next.js)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/arm64
          push: true
          provenance: false
          sbom: false
          build-args: |
            NEXT_PUBLIC_MAPS_PUBLIC_KEY=${{ vars.NEXT_PUBLIC_MAPS_PUBLIC_KEY }}
            NEXT_PUBLIC_APP_VERSION=${{ github.ref_name }}
            NEXT_PUBLIC_MAINTENANCE_MODE=${{ vars.NEXT_PUBLIC_MAINTENANCE_MODE || 'false' }}
          tags: ${{ steps.meta_app.outputs.tags }}
          labels: ${{ steps.meta_app.outputs.labels }}
          cache-from: type=gha,scope=next-app
          cache-to: type=gha,mode=max,scope=next-app

  deploy:
    name: Deploy to Raspberry Pi
    needs: [build_app]
    runs-on: ubuntu-latest
    environment:
      name: PROD
      url: https://mathislambert.fr
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload compose file to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ML_DEPLOY_HOST }}
          username: ${{ secrets.ML_DEPLOY_USER }}
          key: ${{ secrets.ML_DEPLOY_KEY }}
          port: ${{ secrets.ML_DEPLOY_PORT }}
          source: |
            compose.prod.yaml
          target: "/opt/mathislambert.fr/applications/personal_website"

      - name: Remote deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          NEXT_PUBLIC_MAPS_PUBLIC_KEY: ${{ vars.NEXT_PUBLIC_MAPS_PUBLIC_KEY }}
          NEXT_PUBLIC_APP_VERSION: ${{ github.ref_name }}
          NEXT_PUBLIC_MAINTENANCE_MODE: ${{ vars.NEXT_PUBLIC_MAINTENANCE_MODE || 'false' }}
          PUBLIC_BASE_URL: ${{ vars.PUBLIC_BASE_URL }}
          ML_API_BASE_URL: ${{ vars.ML_API_BASE_URL }}
          ML_API_KEY: ${{ secrets.ML_API_KEY }}
          LLM_MODEL_NAME: ${{ vars.LLM_MODEL_NAME }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB: ${{ secrets.MONGODB_DB }}
          ANALYTICS_LOG_RETENTION_DAYS: ${{ vars.ANALYTICS_LOG_RETENTION_DAYS || '180' }}
          ANALYTICS_HASH_SALT: ${{ secrets.ANALYTICS_HASH_SALT }}
          CHAT_LOG_RETENTION_DAYS: ${{ vars.CHAT_LOG_RETENTION_DAYS || '365' }}
          CHAT_LOG_MAX_TEXT_CHARS: ${{ vars.CHAT_LOG_MAX_TEXT_CHARS || '4000' }}
        with:
          host: ${{ secrets.ML_DEPLOY_HOST }}
          username: ${{ secrets.ML_DEPLOY_USER }}
          key: ${{ secrets.ML_DEPLOY_KEY }}
          port: ${{ secrets.ML_DEPLOY_PORT }}
          script_stop: true
          envs: GITHUB_REF_NAME,NEXT_PUBLIC_MAPS_PUBLIC_KEY,NEXT_PUBLIC_APP_VERSION,NEXT_PUBLIC_MAINTENANCE_MODE,PUBLIC_BASE_URL,ML_API_BASE_URL,ML_API_KEY,LLM_MODEL_NAME,NEXTAUTH_SECRET,ADMIN_USERNAME,ADMIN_PASSWORD,INTERNAL_API_USERNAME,INTERNAL_API_PASSWORD,MONGODB_URI,MONGODB_DB,ANALYTICS_LOG_RETENTION_DAYS,ANALYTICS_HASH_SALT,CHAT_LOG_RETENTION_DAYS,CHAT_LOG_MAX_TEXT_CHARS
          script: |
            set -euo pipefail
            OWNER='${{ github.repository_owner }}'
            TAG="$GITHUB_REF_NAME"  # e.g., v1.2.3
            INSTALL_DIR=/opt/mathislambert.fr/applications/personal_website
            OWNER_LC=$(printf '%s' "$OWNER" | tr '[:upper:]' '[:lower:]')

            # Ensure directories and networks exist
            docker network create proxy || true
            docker network create databases || true
            docker network create monitor || true

            # Login to GHCR (requires a PAT with read:packages) if provided
            if [ -n '${{ secrets.GITHUB_TOKEN }}' ]; then
              printf '%s' '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u '${{ secrets.GITHUB_TOKEN || github.actor }}' --password-stdin
            fi

            NEXT_PUBLIC_APP_VERSION=${NEXT_PUBLIC_APP_VERSION:-$TAG}
            NEXT_PUBLIC_MAINTENANCE_MODE=${NEXT_PUBLIC_MAINTENANCE_MODE:-false}
            PUBLIC_BASE_URL=${PUBLIC_BASE_URL:-https://mathislambert.fr}
            ML_API_BASE_URL=${ML_API_BASE_URL:-https://api.mathislambert.fr}
            MONGODB_DB=${MONGODB_DB:-personal_website}
            ANALYTICS_LOG_RETENTION_DAYS=${ANALYTICS_LOG_RETENTION_DAYS:-180}
            CHAT_LOG_RETENTION_DAYS=${CHAT_LOG_RETENTION_DAYS:-365}
            CHAT_LOG_MAX_TEXT_CHARS=${CHAT_LOG_MAX_TEXT_CHARS:-4000}

            cd "$INSTALL_DIR"
            OWNER="$OWNER_LC" IMAGE_TAG="$TAG" docker compose -f compose.prod.yaml pull
            OWNER="$OWNER_LC" IMAGE_TAG="$TAG" \
              NEXT_PUBLIC_MAPS_PUBLIC_KEY="$NEXT_PUBLIC_MAPS_PUBLIC_KEY" \
              NEXT_PUBLIC_APP_VERSION="$NEXT_PUBLIC_APP_VERSION" \
              NEXT_PUBLIC_MAINTENANCE_MODE="$NEXT_PUBLIC_MAINTENANCE_MODE" \
              PUBLIC_BASE_URL="$PUBLIC_BASE_URL" \
              ML_API_BASE_URL="$ML_API_BASE_URL" \
              ML_API_KEY="$ML_API_KEY" \
              LLM_MODEL_NAME="$LLM_MODEL_NAME" \
              NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
              ADMIN_USERNAME="${ADMIN_USERNAME:-$INTERNAL_API_USERNAME}" \
              ADMIN_PASSWORD="${ADMIN_PASSWORD:-$INTERNAL_API_PASSWORD}" \
              MONGODB_URI="$MONGODB_URI" \
              MONGODB_DB="$MONGODB_DB" \
              ANALYTICS_LOG_RETENTION_DAYS="$ANALYTICS_LOG_RETENTION_DAYS" \
              ANALYTICS_HASH_SALT="$ANALYTICS_HASH_SALT" \
              CHAT_LOG_RETENTION_DAYS="$CHAT_LOG_RETENTION_DAYS" \
              CHAT_LOG_MAX_TEXT_CHARS="$CHAT_LOG_MAX_TEXT_CHARS" \
              docker compose -f compose.prod.yaml up -d --remove-orphans

            docker image prune -f || true
