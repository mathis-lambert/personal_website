services:
  frontend:
    image: ghcr.io/${OWNER}/personal-website-frontend:${IMAGE_TAG}
    container_name: personal_frontend
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.personal-frontend.rule=Host(`mathislambert.fr`)"
      - "traefik.http.routers.personal-frontend.entrypoints=websecure"
      - "traefik.http.routers.personal-frontend.tls=true"
      - "traefik.http.routers.personal-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.personal-frontend.loadbalancer.server.port=8080"
    networks: [proxy, monitor]

  backend:
    image: ghcr.io/${OWNER}/personal-website-backend:${IMAGE_TAG}
    container_name: personal_backend
    restart: unless-stopped
    environment:
      MONGODB_HOST: ${MONGODB_HOST}
      MONGODB_PORT: ${MONGODB_PORT}
      MONGODB_USERNAME: ${MONGODB_USERNAME}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD}
      MONGODB_DATABASE: ${MONGODB_DATABASE}
      ML_API_KEY: ${ML_API_KEY}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_EXPIRE_SECONDS: ${JWT_EXPIRE_SECONDS}
      ADMIN_TOKEN_EXPIRE_SECONDS: ${ADMIN_TOKEN_EXPIRE_SECONDS}
      TOKEN_AUDIENCE: ${TOKEN_AUDIENCE}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      LLM_MODEL_NAME: ${LLM_MODEL_NAME}
      INTERNAL_API_USERNAME: ${INTERNAL_API_USERNAME}
      INTERNAL_API_PASSWORD: ${INTERNAL_API_PASSWORD}
      MAINTENANCE_MODE: ${MAINTENANCE_MODE}
      POPULATE_MONGODB: ${POPULATE_MONGODB}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.personal-backend.rule=Host(`mathislambert.fr`) && PathPrefix(`/api`)"
      - "traefik.http.routers.personal-backend.entrypoints=websecure"
      - "traefik.http.routers.personal-backend.tls=true"
      - "traefik.http.routers.personal-backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.personal-backend.loadbalancer.server.port=8081"
    networks: [proxy, databases, monitor]

networks:
  proxy:
    external: true
  databases:
    external: true
  monitor:
    external: true
